# GitHub Actions Workflow for pandoc-wasm
#
# This workflow:
# 1. Tests the package on every push/PR
# 2. Deploys demo to GitHub Pages on main branch
# 3. Creates GitHub releases and publishes to npm on tags
#
# Note: The pandoc.wasm binary is downloaded during the 'prepare' step
# and included in the npm package. It is NOT committed to git.

name: Test, deploy, and release

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Download Pandoc WASM
        run: npm run prepare

      - name: Verify WASM downloaded
        run: |
          if [ ! -f src/pandoc.wasm ]; then
            echo "Error: pandoc.wasm not found"
            exit 1
          fi
          echo "✓ pandoc.wasm found ($(du -h src/pandoc.wasm | cut -f1))"
          ls -lh src/pandoc.wasm

      - name: Run tests
        run: node test-simple.js

  deploy-pages:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
      contents: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Download Pandoc WASM
        run: npm run prepare

      - name: Prepare demo
        run: npm run setup-demo

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: demo

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4

  release:
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    environment:
      name: npm-publish
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"
      - name: Install dependencies
        run: npm install

      - name: Download Pandoc WASM
        run: npm run prepare

      - name: Verify WASM for packaging
        run: |
          if [ ! -f src/pandoc.wasm ]; then
            echo "Error: pandoc.wasm not found - cannot create release package"
            exit 1
          fi
          echo "✓ pandoc.wasm ready for packaging ($(du -h src/pandoc.wasm | cut -f1))"

      - name: Extract version
        id: extract-version
        run: |
          VERSION=$(jq -r .version package.json)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

          # Detect if this is a prerelease version (contains -, e.g., 1.0.0-beta.6)
          if [[ "$VERSION" == *-* ]]; then
            # Extract the prerelease tag (e.g., "beta" from "1.0.0-beta.6")
            PRERELEASE_TAG=$(echo "$VERSION" | sed -E 's/.*-([a-zA-Z]+).*/\1/')
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            echo "npm_tag=${PRERELEASE_TAG}" >> "$GITHUB_OUTPUT"
            echo "Detected prerelease version: $VERSION (tag: ${PRERELEASE_TAG})"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
            echo "npm_tag=latest" >> "$GITHUB_OUTPUT"
            echo "Detected stable version: $VERSION"
          fi

      - name: Create release package
        run: npm pack

      - name: Verify package contents
        run: |
          echo "Package contents:"
          tar -tzf pandoc-wasm-${{ steps.extract-version.outputs.version }}.tgz | sort
          echo ""
          echo "Verifying pandoc.wasm is in package:"
          tar -tzf pandoc-wasm-${{ steps.extract-version.outputs.version }}.tgz | grep pandoc.wasm || (echo "ERROR: pandoc.wasm not found in package!" && exit 1)
          echo "✓ pandoc.wasm is included in package"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: pandoc-wasm-${{ steps.extract-version.outputs.version }}.tgz
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            Release of pandoc-wasm ${{ steps.extract-version.outputs.version }}

            **What's included:**
            - Official Pandoc WASM binary (distributed with package)
            - Modern `convert()` and `query()` API
            - Backward-compatible `pandoc()` API
            - Package size: ~16MB (compressed)
            - No downloads required during installation

            **Installation:**
            ```bash
            npm install pandoc-wasm@${{ steps.extract-version.outputs.version }}
            ```

            See [CHANGELOG.md](https://github.com/pandoc/pandoc-wasm/blob/main/CHANGELOG.md) for complete details.

      - name: Publish to NPM
        if: success()
        run: npm publish --tag ${{ steps.extract-version.outputs.npm_tag }}

      - name: Verify NPM publication
        if: success()
        run: |
          echo "✓ Package published to npm with tag: ${{ steps.extract-version.outputs.npm_tag }}"
          echo "Install with: npm install pandoc-wasm@${{ steps.extract-version.outputs.version }}"
